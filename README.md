# Engine-ECS

## Обзор
FlatFormer - это игровой движок, построенный по архитектуре ECS. Имеет базовые составляющие для создания простых 2D проектов. Целью его разработки было углубление знаний в области основных концепций построения игровых движков.


## Архитектура ECS
### Основные элементы
+ ***Entity*** – представляет собой некоторую сущность, которая находится в мире игры. С точки зрения реализации, Entity – это уникальный идентификатор, с которым связан набор компонентов.

+ ***Component*** – это простая структура данных без сложной логики. Каждый тип компонента можно присоединить к сущности, таким образом наделяя её теми или иными свойствами.
Например, добавив компонент Rigidbody, отвечающий за параметры симуляции твёрдого тела, можно наделить сущность физическими свойствами.

+ ***System*** – класс, который содержит логику определённой части игрового процесса. Каждая система имеет фильтр компонентов, которые требуются ей для выполнения задачи.
Например, физическая система может получать на вход выборку сущностей, которые содержат компонент Rigidbody, и применяет к ним гравитацию.

### Вспомогательные элементы
+ ***IDPool*** – занимается генерацией новых уникальных идентификаторов для сущностей и компонентов. Также поддерживает список освободившихся идентификаторов для повторного использования.

+ ***TypeIDCounter*** – выполняет схожую с IDPool задачу, но отвечает за статические идентификаторы типов. Идентификаторы типов необходимы для быстрого доступа и сравнения списков компонентов.

+ ***ComponentFilter*** – фильтр компонентов, представляющий маску, по которой отбираются сущности с определённым набором компонентов. Он необходим для того, чтобы обеспечивать системы только теми сущностями, которые обладают необходимым набором данных для выполнения той или иной задачи.

### Менеджеры
+ ***EntityManager*** – отвечает за создание/удаление и хранение сущностей с уникальными идентификаторами. Поддерживает список активных/неактивных сущностей и оповещает других менеджеров об изменении состояния объектов.

+ ***ComponentManager*** – отвечает за создание/удаление компонентов и их привязку к сущностям.

+ ***SystemManager*** – отвечает за хранение систем и их обновление в игровом цикле. Также занимается добавлением/удалением сущностей из систем в соответсвии с их фильтрами компонентов.


## Другие элементы
1. ***Управление памятью*** - за управлением общей памятью программы в проекте отвечает MemoryManager. Он выделяет и делегирует контроль за участками памяти специализированным аллокаторам, которые используются подсистемами движка. Всего в проекте реализовано 4 вида аллокаторов:
   + LinearAllocator
   + StackAllocator
   + PoolAllocator
   + QueueAllocator

2. ***Работа с ассетами*** - для работы с ресурсами в проекте реализован AssetCache. Он отвечает за загрузку ассетов из архива, преобразование в формат движка, а также поддержание списка LRU (last recently used) для отслеживания актуальных/неактуальных ресурсов.

3. ***Система событий*** - представляет централизованное место для обмена системными сообщениями. EventSystem является посредником между инициаторами событий и слушателями, сопоставляя типы событий с делегатами объектов-обработчиков.

4. ***Компонент трансформации*** - для создания иерархии сущностей на сцене был создан компонент Transform. Он хранит информацию о глобальном и локальном расположении объекта в пространстве и осуществляет пересчёт изменений при перемещении, вращении и масштабировании. Для оптимизации пересчётов трансформаций дочерних объектов был использован паттерн "dirty flag". Его идея заключается в том, чтобы пересчитывать трансформации только тех объектов, у которых она запрашивается.

5. ***Система коллизий*** - служит для выявления кандидатов на пересечение в пространстве. Поиск коллизий разделён на две фазы - широкую и узкую. Во время **широкой фазы** производится проверка на пересечение ограничивающих прямоугольников AABB - упрощённом представлении форм объектов. Для оптимизации проверок игровое пространство разделено на квадранты, формирующие дерево поиска **QuadTree**. Во время **узкой фазы**, найденные коллайдеры из предыдущей фазы проверяются на пересечение уже с использованием SAT - seperating axes theorem. В результате проверки формируется структура contactInfo, которая затем используется для вывода объектов из коллизии.

6. ***Система физики*** - для представления твёрдого тела реализован компонент RigidBody, хранящий информацию о массе, линейной скорости, инерции, угловой скороси и свойствах материала. PhysicSystem отвечает за симуляцию тел в соответсвии со своими характеристиками, а также за ограничение скоростей и позиций объектов в момент взаимодействия нескольких RigidBody между собой.

